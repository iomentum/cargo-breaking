<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Guide to cargo-breaking Development</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="1_foreword.html"><strong aria-hidden="true">1.</strong> Foreword</a></li><li class="chapter-item expanded "><a href="2_0_process.html"><strong aria-hidden="true">2.</strong> Process</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="2_1_overview.html"><strong aria-hidden="true">2.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="2_2_config.html"><strong aria-hidden="true">2.2.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="2_3_manifest.html"><strong aria-hidden="true">2.3.</strong> Manifest file</a></li><li class="chapter-item expanded "><a href="2_4_crate.html"><strong aria-hidden="true">2.4.</strong> Code fetching</a></li><li class="chapter-item expanded "><a href="2_5_rustdoc.html"><strong aria-hidden="true">2.5.</strong> Rustdoc execution</a></li><li class="chapter-item expanded "><a href="2_6_comparison.html"><strong aria-hidden="true">2.6.</strong> Comparison</a></li><li class="chapter-item expanded "><a href="2_7_next_version.html"><strong aria-hidden="true">2.7.</strong> Next version</a></li></ol></li><li class="chapter-item expanded "><a href="3_book.html"><strong aria-hidden="true">3.</strong> Book</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Guide to cargo-breaking Development</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="foreword"><a class="header" href="#foreword">Foreword</a></h1>
<p>The goal of this book is to help you understand the inner-workings of cargo-breaking and how it compares two versions of a Rust project to display the differences between both.</p>
<p>Example:</p>
<pre><code>$ cargo breaking
- user::User::from_str
â‰  user::User
+ user::User::from_path
+ user::User::[impl Debug]

Next version is: 3.0.0
</code></pre>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p><code>cargo-breaking</code> needs the nightly toolchain to be installed to work correctly,
but can be compiled with any toolchain. It can be compiled from sources with the
following commands:</p>
<pre><code class="language-none">$ git clone https://github.com/iomentum/cargo-breaking
$ cd cargo-breaking
$ cargo install --path ./
</code></pre>
<p>You may need to add the <code>--force</code> argument to the last command if you're
upgrading from a previous version.</p>
<h3 id="git-workflow"><a class="header" href="#git-workflow">Git workflow</a></h3>
<p>Most work is done in separate branches, before getting merged to <code>main</code> all
at once, once the quality of the code is judged to be good enough. The branches
usually follow the naming convention <code>author/feature-name</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="process"><a class="header" href="#process">Process</a></h1>
<p>This section describes the execution flow of cargo-breaking.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>The process used by cargo-breaking can be summarized like this:</p>
<ul>
<li><a href="./2_2_config.html">2.2</a>: The configuration is parsed from the CLI args and other configuration sources</li>
<li><a href="./2_3_manifest.html">2.3</a>: The crate metadata is read from the manifest file</li>
<li><a href="./2_4_crate.html">2.4</a>: The source code for the previous and the next version is fetched using Git in a temporary directory</li>
<li><a href="./2_5_rustdoc.html">2.5</a>: Both codebases are ran through rustdoc and the JSON output is then deserialized</li>
<li><a href="./2_6_comparison.html">2.6</a>: The comparison is performed and the output is collected as a list of differences</li>
<li><a href="./2_7_next_version.html">2.7</a>: The &quot;best&quot; next version is suggested from the diagnosis list</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>cargo-breaking supports loading configuration data from the following sources, in order of priority (highest to lowest):</p>
<ul>
<li>Command-line parameters, using <a href="https://github.com/clap-rs/clap">clap</a></li>
<li>Environment variables, with the prefix <code>CARGO_BREAKING_</code></li>
<li>The <code>cargo-breaking.toml</code> file</li>
<li>The <code>cargo-breaking.json</code> file</li>
</ul>
<p>Configuration files are searched for in the current working directory.</p>
<p>The loaded configuration is exposed via <code>cli::config</code>'s <code>get() -&gt; &amp;'static ProgramConfig</code> function.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="manifest-file"><a class="header" href="#manifest-file">Manifest file</a></h1>
<p>cargo-breaking searches for the <code>Cargo.toml</code> file in the current working directory, or in a subdirectory if a package is specified via <code>-p</code> / <code>--package</code>.</p>
<p>The file is then read and deserialized, and the crate's package name and version is fetched.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="code-fetching"><a class="header" href="#code-fetching">Code fetching</a></h1>
<p>Once the crate's metadata has been decoded, cargo-breaking fetches the code for the previous and the next version in a
temporary directory. This is done by copying the <code>.git</code> folder in two different directories, and then checking out 
respectively the revspec specified via <code>-a</code> / <code>--against</code> and the <code>HEAD</code> revspec.</p>
<p>cargo-breaking internally supports a second loading source, which is used for loading raw code files directly. This is 
used by the test harness to compare two single-file libraries.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rustdoc-execution"><a class="header" href="#rustdoc-execution">Rustdoc execution</a></h1>
<p>The following command is executed in each of the two codebases:</p>
<pre><code class="language-shell">cargo +nightly rustdoc --lib ... -- -Zunstable-options -wjson
</code></pre>
<p>where <code>...</code> represent additional optional Cargo arguments depending on the settings:</p>
<ul>
<li><code>--features</code></li>
<li><code>--no-default-features</code></li>
<li><code>--all-features</code></li>
</ul>
<p>Rustdoc writes its output in the <code>target/doc/{package_name}.json</code> file, which is then read and deserialized into a 
<code>Crate</code> object.</p>
<h2 id="types-handling"><a class="header" href="#types-handling">Types handling</a></h2>
<p>The <code>rustdoc_types</code> crate contain copies of the Rustdoc internal type hierarchy, directly extracted from the rustc 
repository. This allows reading the type without having to depend on the whole rustc codebase.</p>
<p>However, because of the processing we are doing on the Rustdoc output, we ourselves had to make copies of those types,
to make some changes in the way some things are stored, for example IDs.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="comparison"><a class="header" href="#comparison">Comparison</a></h1>
<p>The <code>Crate</code> object from Rustdoc is converted to a <code>PublicApi</code> object, which is a flat hashmap of all public items in 
the library.</p>
<h2 id="translation"><a class="header" href="#translation">Translation</a></h2>
<p>The <code>Crate</code> object is traversed and all its items associated to the root crate (ID 0) are processed.</p>
<h3 id="functions"><a class="header" href="#functions">Functions</a></h3>
<p>Free functions and methods yield <code>Fn</code> and <code>Method</code> items, respectively.</p>
<h3 id="types"><a class="header" href="#types">Types</a></h3>
<p>Structures, unions and enums yield <code>Type</code> items, and their fields and impls are also traversed.</p>
<h4 id="fields"><a class="header" href="#fields">Fields</a></h4>
<p>Fields yield <code>Field</code> items.</p>
<h4 id="impls"><a class="header" href="#impls">Impls</a></h4>
<p>Impl items are processed and yield either <code>Method</code>, <code>AssocType</code> or <code>AssocConst</code> items.</p>
<p>If the impl is for a trait, it yields a <code>TraitImpl</code> item.</p>
<h3 id="trait-definitions"><a class="header" href="#trait-definitions">Trait definitions</a></h3>
<p>Trait definitions yield <code>TraitDef</code> items, and their items are processed in the same way as for impl items.</p>
<h3 id="modules"><a class="header" href="#modules">Modules</a></h3>
<p>Modules yield <code>Module</code> items.</p>
<p>Their items are not directly processed since they already appear in the <code>Crate</code> index.</p>
<h3 id="typedefs"><a class="header" href="#typedefs">Typedefs</a></h3>
<p>Typedefs yield <code>Type</code> items.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="next-version"><a class="header" href="#next-version">Next version</a></h1>
<p>If the diagnosis contains breaking changes, the major version is incremented. Otherwise, if it contains additions,
the minor version is incremented. Otherwise, the patch version is incremented.</p>
<h2 id="breaking-changes"><a class="header" href="#breaking-changes">Breaking changes</a></h2>
<p>Currently, only modifications are considered breaking changes.</p>
<p><strong>Note:</strong> additions of public fields to a structure also yield a modification of the structure itself. The additions
are not internally considered breaking, the structure's modification is. This is to avoid having to handle different
kinds of additions in the comparison phase; we can simply emit a modification if we detect that the addition is 
breaking.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="book"><a class="header" href="#book">Book</a></h1>
<p>Mdbook is needed to get running this book:</p>
<pre><code class="language-none">$ cargo install mdbook
$ cd book
$ mdbook serve --dest-dir ../docs
</code></pre>
<h3 id="building-the-book"><a class="header" href="#building-the-book">Building the book</a></h3>
<p>This updates the book so it is updated on push.</p>
<p>// TODO! add this as a pre-commit hook</p>
<pre><code>$ cd book
$ mdbook build --dest-dir ../docs
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
